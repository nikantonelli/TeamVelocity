<!DOCTYPE html>
<html>
<head>
    <title>TeamVelocity</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("iterRecord",{extend:"Ext.data.Model",fields:[{name:"Iteration",type:"string"},{name:"During",type:"int"},{name:"After",type:"int"},{name:"Total",type:"float"},{name:"Average",type:"float"}]}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",id:"header",layout:"column",align:"center",items:[{xtype:"rallydatefield",id:"StartDate",stateful:!0,fieldLabel:"Start Date",value:Ext.Date.subtract(new Date,Ext.Date.DAY,90)},{xtype:"rallydatefield",fieldLabel:"End Date",stateful:!0,id:"EndDate",value:new Date}]},{xtype:"container",id:"body"}],iterStore:null,iterationOIDs:[],_chartRefresh:function(){Ext.getCmp("CapChart").destroy(),this.iterationOIDs=[],this.iterStore.destroyStore(),this._startApp(this)},launch:function(){this.add({}),Ext.getCmp("StartDate").on({change:this._chartRefresh,scope:this}),Ext.getCmp("EndDate").on({change:this._chartRefresh,scope:this}),this._startApp(this)},_startApp:function(t){t.iterStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:"true",filters:[{property:"StartDate",operator:">",value:Ext.getCmp("StartDate").getValue()},{property:"StartDate",operator:"<",value:Ext.getCmp("EndDate").getValue()}],sorters:[{property:"StartDate",direction:"ASC"}],listeners:{load:function(e,a,r){t._getUtilisation(t,a)}}})},_getUtilisation:function(t,e){var a=[];_.each(e,function(t){a.push({property:"Iteration",value:t.get("_ref")})}),0===a.length&&(a=null),usStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",limit:1/0,filters:Rally.data.wsapi.Filter.or(a),autoLoad:"true",listeners:{load:function(a,r,o){var n=[];_.each(e,function(t){n.push({Iteration:t,data:_.filter(r,function(e){return!!e.get("Iteration")&&e.get("Iteration")._ref===t.get("_ref")})})});var l=[];_.each(n,function(t){if(t.data.length){var e=t.Iteration.get("_refObjectName")+" ("+t.Iteration.get("Project")._refObjectName+")",a=0,r=0,i=0,o=t.Iteration.get("EndDate");_.each(t.data,function(t){t.get("AcceptedDate")&&(t.get("AcceptedDate")<=o?a+=t.get("PlanEstimate"):r+=t.get("PlanEstimate"),i+=t.get("PlanEstimate"))}),l.push({Iteration:e,During:a,After:r,Total:i,Average:0})}});Math.floor(_.max(_.pluck(l,"Total"))/50);var s=t._leastSquares(_.pluck(l,"Total"),1,l.length);for(i=0;i<l.length;i++)l[i].Average=s.yintercept+(i+1)*s.slope;var p=Ext.create("Ext.data.Store",{model:"iterRecord",data:l,proxy:"memory"}),c=["#f9a814","#ee6c19","#105cab","#107c1e","#df1a7b","#4a1d7e"];Ext.chart.theme.appTheme=Ext.extend(Ext.chart.theme.Base,{constructor:function(t){Ext.chart.theme.Base.prototype.constructor.call(this,Ext.apply({colors:c},t))}}),Ext.getCmp("body").add({xtype:"chart",theme:"appTheme",id:"CapChart",store:p,style:"background:#fff",animate:!0,autoShow:!0,height:600,width:1024,legend:{position:"bottom"},axes:[{type:"Numeric",position:"left",field:["During","After","Total","Average"],title:"Velocity",grid:!0},{type:"Category",position:"bottom",fields:["Iteration"],title:"Iteration",label:{rotate:{degrees:90}}}],plotOptions:{column:{stacking:"normal"}},series:[{type:"column",axis:"left",xField:"Iteration",yField:["During","After"],markerConfig:{type:"cross",size:3},tips:{trackMouse:!0,renderer:t._tipsRenderer}},{type:"line",axis:"left",highlight:!0,xField:"Iteration",yField:"Average",markerConfig:{type:"circle",size:3}},{type:"line",axis:"left",highlight:!0,xField:"Iteration",yField:"Total",markerConfig:{type:"cross",size:3}}]})}},fetch:["AcceptedDate","Iteration","PlanEstimate"]})},_tipsRenderer:function(t,e){this.setTitle(e.yField),this.update(e.value[1])},_leastSquares:function(t,e,a){var r,i=a+1-e,o=0,n=0,l=0,s=0;for(r=e;r<=a;r++)o+=r,n+=r*r,l+=t[r-1],t[r-1]*t[r-1],s+=r*t[r-1];return{slope:(i*s-o*l)/(i*n-o*o),yintercept:(l*n-o*s)/(i*n-o*o)}}});

            Rally.launchApp('CustomApp', {
                name:"TeamVelocity",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
